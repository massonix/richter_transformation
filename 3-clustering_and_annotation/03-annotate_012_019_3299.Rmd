---
title: 'Annotate tumoral cells'
author: "Ramon Massoni-Badosa"
date: "2021/04/09"
output: 
  BiocStyle::html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "100%", fig.align='center', 
                      message=FALSE, warning = FALSE)
options(width = 1200)
```


# Introduction

The purpose of this notebook is to find markers for each of the clusters defined previously, so that we can annotate them to specific clones or cell types.


# Pre-processing

## Load packages

```{r}
library(Seurat)
library(SeuratWrappers)
library(harmony)
library(tidyverse)
```


## Define parameters

```{r}
# Paths
path_to_obj <- here::here("results/R_objects/5.seurat_list_clustered.rds")
path_to_save <- here::here("results/R_objects/6.seurat_list_annotated.rds")


# Colors
color_palette <- c("black", "gray", "red", "yellow", "violet", "green4",
                   "blue", "mediumorchid2", "coral2", "blueviolet",
                   "indianred4", "deepskyblue1", "dimgray", "deeppink1",
                   "green", "lightgray", "hotpink1")


# Source functions
source(here::here("bin/utils.R"))
```


## Load data

```{r}
seurat_list <- readRDS(path_to_obj)
purrr::map(seurat_list, DimPlot)
purrr::map(seurat_list, DimPlot, group.by = "is_richter")
```


# Cell Cycle Score

As upregulation of cell cycle genes is a hallmark of Richter transformation, we will infer the cell cycle score and phase for each cell:

```{r}
seurat_list <- purrr::map(seurat_list, function(seurat_obj) {
  seurat_obj <- CellCycleScoring(
    seurat_obj,
    s.features = cc.genes.updated.2019$s.genes,
    g2m.features = cc.genes.updated.2019$g2m.genes,
    set.ident = FALSE
  )
  seurat_obj
})
cc_phase_ggs <- purrr::map(seurat_list, DimPlot, group.by = "Phase")
s_score_ggs <- purrr::map(seurat_list, function(seurat_obj) {
  p <- FeaturePlot(seurat_obj, features = "S.Score") +
    scale_color_viridis_c(option = "magma")
  p
})
g2m_score_ggs <- purrr::map(seurat_list, function(seurat_obj) {
  p <- FeaturePlot(seurat_obj, features = "G2M.Score") +
    scale_color_viridis_c(option = "magma")
  p
})
cc_phase_ggs
s_score_ggs
g2m_score_ggs
```

# Find Markers

```{r}
markers_list <- purrr::map(
  seurat_list,
  FindAllMarkers,
  only.pos = TRUE,
  logfc.threshold = 0.5
)
markers_list <- purrr::map(markers_list, function(df) {
  df <- df %>%
    group_by(cluster) %>%
    arrange(desc(avg_log2FC), .by_group = TRUE)
  df
})

print("Markers 012")
DT::datatable(markers_list$`12`)

print("Markers 019")
DT::datatable(markers_list$`19`)

print("Markers 3299")
DT::datatable(markers_list$`3299`)

saveRDS(
  markers_list,
  here::here("3-clustering_and_annotation/tmp/markers_richter.rds")
)
```


We can also compare all Richter-like clones against CLL:

```{r}
markers_richter_12 <- FindMarkers(
  seurat_list$`12`,
  ident.1 = c("2", "3"),
  ident.2 = c("0", "1"),
  only.pos = FALSE,
  logfc.threshold = 0.5
)
DT::datatable(markers_richter_12)

markers_richter_19 <- FindMarkers(
  seurat_list$`19`,
  ident.1 = c("0", "1"),
  ident.2 = c("2"),
  only.pos = FALSE,
  logfc.threshold = 0.5
)
DT::datatable(markers_richter_19)

markers_richter_3299 <- FindMarkers(
  seurat_list$`3299`,
  ident.1 = "2",
  ident.2 = c("0", "1"),
  only.pos = FALSE,
  logfc.threshold = 0.5
)
DT::datatable(markers_richter_3299)
```

Interesting observations:

- H2AFY
- MIF
- LILRA4
- TCL1A
- PRDM2
- MIR155HG
- INPP5D
- XBP1
- CLPTM1L
-	AC007952.4
- AC245014.3


# Annotation

## Patient 012

| Cluster | Markers                   | Annotation                 |
|---------|---------------------------|----------------------------|
| 0       | CXCR4                     | CXCR4+CD27-                |
| 1       | CD27                      | CXCR4-CD27+                |
| 2       | MIF                       | Richter-like quiescent     |
| 3       | TOP2A, MKI67              | Richter-like proliferative |
| 4       | MT-ND1, MT-CO3            | poor-quality               |
| 5       | MZB1, IGHM, XBP1, CLPTM1L | MZB1+IGHM++XBP1+           |
| 6       | HBM                       | erythrocytes               |


```{r}
annotation_012 <- c("CXCR4+CD27-", "CXCR4-CD27+", "Richter-like quiescent",
                    "Richter-like proliferative", "poor-quality",
                    "MZB1+IGHM++XBP1+", "erythrocytes")
seurat_list$`12`$seurat_clusters <- Idents(seurat_list$`12`)
seurat_list$`12`$annotation <- Idents(seurat_list$`12`)
levels(seurat_list$`12`$annotation) <- annotation_012
Idents(seurat_list$`12`) <- "annotation"
DimPlot(seurat_list$`12`, cols = color_palette)
```


## Patient 019

| Cluster | Markers                   | Annotation                 |
|---------|---------------------------|----------------------------|
| 0       | CXCR4                     | CXCR4+CD27-                |
| 1       | CD27                      | CXCR4-CD27+                |
| 2       | CCR7                      | Richter-like quiescent     |
| 3       | MALAT                     | poor-quality               |
| 4       | TOP2A, MKI67              | Richter-like proliferative |
| 5       | HBM                       | erythrocytes               |


```{r}
annotation_019 <- c("CXCR4+CD27-", "CXCR4-CD27+", "Richter-like quiescent",
                    "poor-quality", "Richter-like proliferative", "erythrocytes")
seurat_list$`19`$seurat_clusters <- Idents(seurat_list$`19`)
seurat_list$`19`$annotation <- Idents(seurat_list$`19`)
levels(seurat_list$`19`$annotation) <- annotation_019
Idents(seurat_list$`19`) <- "annotation"
DimPlot(seurat_list$`19`, cols = color_palette)
```


## Patient 3299

| Cluster | Markers                   | Annotation                 |
|---------|---------------------------|----------------------------|
| 0       | CXCR4                     | CXCR4+CD27-                |
| 1       | CD27                      | CXCR4-CD27+                |
| 2       | KLF6                      | Richter-like quiescent     |
| 3       | mitochondrial genes       | poor-quality               |
| 4       | MIR155HG                  | MIR155HG                   |
| 5       | HBM/TOP2A                 | erythrocytes/proliferative |


```{r}
annotation_3299 <- c("CXCR4+CD27-", "CXCR4-CD27+", "Richter-like quiescent",
                    "poor-quality", "MIR155HG", "erythrocytes/proliferative")
seurat_list$`3299`$seurat_clusters <- Idents(seurat_list$`3299`)
seurat_list$`3299`$annotation <- Idents(seurat_list$`3299`)
levels(seurat_list$`3299`$annotation) <- annotation_3299
Idents(seurat_list$`3299`) <- "annotation"
DimPlot(seurat_list$`3299`, cols = color_palette)
```


In all 3 donors we have seen a a cluster of poor-quality cells, but that has a high expression of important CLL genes: CHD2 and ATM, among others. Thus, we need to check carefully before excluding them.


# Save

```{r}
saveRDS(seurat_list, path_to_save)
```


# Session Information

```{r}
sessionInfo()
```
