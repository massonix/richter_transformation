---
title: 'Validate seed cells are not doublets'
author: "Ramon Massoni-Badosa"
date: "2021/04/09"
output: 
  BiocStyle::html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "100%", fig.align='center', 
                      message=FALSE, warning = FALSE)
options(width = 1200)
```

TODO:
- Look at the RT HTO expression of the "seed" cells. If they are indeed not true doublets, the HTO expression should not be in the right tail of the distribution.


# Introduction

The purpose of this notebook is to ensure that the Richter-like cells predicted at the initial time points of the disease do not correspond to doublets. To that end, we will merge the RT-CLL predicted doublets detected by cell hashing with the filtered Seurat objects. This ground-truth doublets should cluster at the interface between CLL and RT clusters, while the RT-like cells should be embedded in the clusters.


# Pre-processing

## Load packages

```{r}
library(Seurat)
library(ggpubr)
library(tidyverse)
```


## Define parameters

```{r}
path_to_obj <- here::here("results/R_objects/patient_63/7.seurat_list_annotated_reprocessed.rds")
path_to_demultiplex <- here::here("results/R_objects/demultiplexed")
path_to_libraries_metadata <- here::here("1-cellranger_mapping/data/richter_metadata.csv")
path_to_sample_metdata <- here::here("data/sample_metadata_FN.csv")


# Colors
color_palette <- c("black", "gray", "red", "yellow", "violet", "green4",
                   "blue", "mediumorchid2", "coral2", "blueviolet",
                   "indianred4", "deepskyblue1", "dimgray", "deeppink1",
                   "green", "lightgray", "hotpink1")


# Source functions
source(here::here("bin/utils.R"))
```


## Load data

```{r}
seurat_list <- readRDS(path_to_obj)
seurat_list$`12`$annotation_final <- Idents(seurat_list$`12`)
seurat_list$`19`$annotation_final <- Idents(seurat_list$`19`)
seurat_list$`3299`$annotation_final <- Idents(seurat_list$`3299`)
seurat_list$`3299`$is_richter <- ifelse(
  seurat_list$`3299`$time_point %in% c("T2", "T3"),
  TRUE,
  FALSE
)
seurat_list
umaps_annotation <- purrr::map(
  seurat_list,
  DimPlot,
  cols = color_palette,
  pt.size = 0.5,
  group.by = "annotation_final"
)
umaps_annotation


# Load demultiplexed files (with doublets)
files_to_load <- list.files(path_to_demultiplex, full.names = TRUE)
gem_ids <- list.files(path_to_demultiplex, full.names = FALSE) %>%
  str_remove("^seurat_") %>%
  str_remove("_demultiplexed.rds$")
names(files_to_load) <- gem_ids
seurat_demultiplexed <- purrr::map(files_to_load, readRDS)


# Load metadata files
libraries_metadata <- read_csv(path_to_libraries_metadata)
samples_metadata <- read_csv(path_to_sample_metdata)
DT::datatable(libraries_metadata)
DT::datatable(samples_metadata)
```


# Keep RT-CLL doublets and subset

```{r}
seurat_demultiplexed_12 <- merge(
  x = seurat_demultiplexed$r65huxjg_g0itbe2k,
  y = seurat_demultiplexed$bco1we6n_qaz6s7wd
)
seurat_demultiplexed_19 <- merge(
  x = seurat_demultiplexed$te04uhdq_2uatjn5y,
  y = seurat_demultiplexed$j7z61du3_vyxon6q4
)
seurat_demultiplexed_3299 <- merge(
  x = seurat_demultiplexed$p092mcjf_6w9km8re,
  y = seurat_demultiplexed$z97dxyfq_xi38kvhc
)
seurat_demultiplexed <- list(
  "12" = seurat_demultiplexed_12,
  "19" = seurat_demultiplexed_19,
  "3299" = seurat_demultiplexed_3299
)
rm(seurat_demultiplexed_12)
rm(seurat_demultiplexed_19)
rm(seurat_demultiplexed_3299)


richter_samples <- c(
  "ICGC-365-15-194",
  "ICGC-01918-3879A",
  "ICGC-012-19-4600B",
  "ICGC-3299-17-251",
  "ICGC-3299-18-218A",
  "ICGC-3299-18-5761A"
)
richter_annotations <- c(
  "CCND2hi Richter-like quiescent",
  "CCND2lo Richter-like quiescent",
  "Richter-like proliferative",
  "TP53INP1hi Richter-like quiescent",
  "MIR155HGhi CD20hi Richter-like quiescent",
  "Richter-like proliferative",
  "Richter-like"
)
seurat_list <- purrr::map(seurat_list, function(seurat_obj) {
  seurat_obj$annotation_final <- as.character(seurat_obj$annotation_final)
  seurat_obj
})
seurat_demultiplexed2 <- purrr::map(names(seurat_list), function(x) {
  rt_cll_doublets <- 
    (seurat_demultiplexed[[x]]$HTO_maxID %in% richter_samples |
       seurat_demultiplexed[[x]]$HTO_secondID %in% richter_samples) &
    seurat_demultiplexed[[x]]$HTO_classification.global == "Doublet"
  rt_cll_doublets <- colnames(seurat_demultiplexed[[x]])[rt_cll_doublets]
  rt_seed_cells <- 
    seurat_list[[x]]$is_richter == FALSE &
    seurat_list[[x]]$annotation_final %in% richter_annotations
  rt_seed_cells <- colnames(seurat_list[[x]])[rt_seed_cells]
  background_cells <- !(colnames(seurat_list[[x]]) %in% rt_seed_cells)
  background_cells <- colnames(seurat_list[[x]])[background_cells]
  selected_cells <- Reduce(
    union,
    list(rt_cll_doublets, rt_seed_cells, background_cells)
  )
  seurat_obj <- subset(seurat_demultiplexed[[x]], cells = selected_cells)  
  seurat_obj$gem_id <- str_sub(colnames(seurat_obj), start = 1, end = 17)
  seurat_obj$classification <- case_when(
    colnames(seurat_obj) %in% rt_cll_doublets ~ "RT-CLL doublets",
    colnames(seurat_obj) %in% rt_seed_cells ~ "RT seeds",
    colnames(seurat_obj) %in% background_cells ~ "Background",
  )
  seurat_obj$annotation_final <- "unannotated"
  seurat_obj$annotation_final[background_cells] <- seurat_list[[x]]$annotation_final[background_cells]
  seurat_obj$annotation_final[rt_seed_cells] <- seurat_list[[x]]$annotation_final[rt_seed_cells]
  seurat_obj$annotation_final[rt_cll_doublets] <- "RT-CLL doublets"
  seurat_obj$donor_id <- x
  Idents(seurat_obj) <- "annotation_final"
  seurat_obj
})
names(seurat_demultiplexed2) <- names(seurat_list)
rm(seurat_demultiplexed)
```


# Reprocess merged objects

```{r fig.wide=TRUE}
seurat_demultiplexed2 <- purrr::map(seurat_demultiplexed2, NormalizeData)
seurat_demultiplexed2 <- purrr::map(
  seurat_demultiplexed2,
  process_seurat,
  dims = 1:20
)
purrr::map(seurat_demultiplexed2, DimPlot, pt.size = 0.5, cols = color_palette)
```

# Plot

First, we will assess whether Richter transformation (RT) "seed" cells colocalize with doublets:

```{r}
# Split UMAP by background, "seed cells" and RT-CLL doublets
umap_doublets <- purrr::map(
  seurat_demultiplexed2,
  plot_split_umap,
  var = "classification"
)
umap_doublets
```


# Hashtag Oligonucleotide distribution

Next, we seek to elucidate the HTO of the RT samples in seed cells. RT seed cells which, by definition, are classified as singlets of a non-RT time-point. Thus, if they are not doublets they should not have a significantly higher expression of the RT HTO:

```{r fig.wide=TRUE}
# Patients 12 and 19
# Violin plots
violin_plots_12_19 <- purrr::map(
  seurat_demultiplexed2[c("12", "19")],
  function(seurat_obj) {
    DefaultAssay(seurat_obj) <- "HTO"
    selected_features <- rownames(seurat_obj)[rownames(seurat_obj) %in% richter_samples]
    seurat_obj <- subset(seurat_obj,  features = selected_features)
    seurat_obj$richter_hto <- seurat_obj[["HTO"]]@data[1, ]
    p <- seurat_obj@meta.data %>%
      ggplot(aes(classification, richter_hto, fill = classification)) +
        geom_violin() +
        facet_wrap(~gem_id) +
        labs(x = "", y = "RT HTO normalized expression", fill = "") +
        theme_bw() +
        theme(legend.position = "none")
    p
  })


# Ridge plots
density_plots_12_19 <- purrr::map(
  seurat_demultiplexed2[c("12", "19")],
  function(seurat_obj) {
  DefaultAssay(seurat_obj) <- "HTO"
  selected_features <- rownames(seurat_obj)[rownames(seurat_obj) %in% richter_samples]
  seurat_obj <- subset(seurat_obj,  features = selected_features)
  seurat_obj$richter_hto <- seurat_obj[["HTO"]]@data[1, ]
  p <- seurat_obj@meta.data %>%
    ggplot(aes(x = richter_hto, y = classification, fill = classification)) +
      geom_density_ridges() +
      facet_wrap(~gem_id) +
      labs(x = "RT HTO normalized expression", y = "", fill = "") +
      theme_bw() +
      theme(legend.position = "none")
  p
})
density_plots_12_19
```


# RT and CLL signatures

Finally, we will score each cell with a RT or CLL-specific signature, which we calculated in another notebook. If the RT seed cells are truly Richter-like, they should have a high RT signature and low CLL signature. On the other hand, if they are RT-CLL doublets, they will have an intermediate signature in both:


```{r}

```


# Session Info

```{r}
sessionInfo()
```
