---
title: 'Clonal evolution'
author: "Ramon Massoni-Badosa"
date: "2021/04/09"
output: 
  BiocStyle::html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "100%", fig.align='center', 
                      message=FALSE, warning = FALSE)
options(width = 1200)
```


# Introduction

The purpose of this notebook is to assess the transcriptional signature associated with Richter transformation.


# Pre-processing

## Load packages

```{r}
library(Seurat)
library(SeuratWrappers)
library(harmony)
library(UpSetR)
library(enrichR)
library(clusterProfiler)
library(org.Hs.eg.db)
library(ggrepel)
library(ggforce)
library(tidyverse)
```


## Define parameters

```{r}
# Paths
path_to_obj <- here::here("results/R_objects/patient_63/7.seurat_list_annotated_reprocessed.rds")
path_to_obj_63 <-  here::here("results/R_objects/patient_63/3.seurat_LN_annotated.rds")
path_to_save_richter_signature <- here::here("results/R_objects/richter_signatures_list.rds")
path_to_save_cll_signature <- here::here("results/R_objects/cll_signatures_list.rds")


# Colors
color_palette <- c("black", "gray", "red", "yellow", "violet", "green4",
                   "blue", "mediumorchid2", "coral2", "blueviolet",
                   "indianred4", "deepskyblue1", "dimgray", "deeppink1",
                   "green", "lightgray", "hotpink1")


# Source functions
source(here::here("bin/utils.R"))


# Thresholds
alpha <- 0.001
min_avg_log2FC <- 0.25
selected_avg_log2FC <- 1.25
selected_pct_cells <- 10
selected_significance_alpha <- alpha
GO_max_total_genes <- 250
GO_min_enriched_genes <- 3
GO_p_adj_threshold <- 0.01
GO_min_odds_ratio <- 2.5
max_gs_size <- 250
min_gs_size <- 10
```


## Load data

```{r}
seurat_list <- readRDS(path_to_obj)
seurat_63 <- readRDS(path_to_obj_63)
seurat_list <- c(seurat_list, "63" = seurat_63)
seurat_list
```


# Differential expression analysis

```{r}
seurat_list$`12`$annotation_final <- Idents(seurat_list$`12`)
seurat_list$`19`$annotation_final <- Idents(seurat_list$`19`)
seurat_list$`3299`$annotation_final <- Idents(seurat_list$`3299`)
seurat_list$`63`$annotation_final <- Idents(seurat_list$`63`)

comparisons <- list(
  "12" = list(
    richter = c("CCND2lo Richter-like quiescent", "CCND2hi Richter-like quiescent"),
    cll = c("CXCR4-CD27+", "CXCR4+CD27-", "MIR155HG+", "MZB1+IGHM++XBP1+")
  ),
  "19" = list(
    richter = c("TP53INP1hi Richter-like quiescent", "MIR155HGhi CD20hi Richter-like quiescent"),
    cll = c("CXCR4-CD27+", "CXCR4+CD27-", "MIR155HGhi CLL-like")
  ),
  "3299" = list(
    richter = c("Richter-like"),
    cll = c("CD27+S100A4+", "CD83hiMIR155HGhi", "CXCR4-CD27+", "CXCR4+CD27-", "CD83loMIR155HGhi")
  ),
  "63" = list(
    richter = c("Richter-like"),
    cll = c("CXCR4+ CLL-like")
  )
)
dea <- purrr::map(names(comparisons), function(x) {
  print(x)
  seurat_obj <- seurat_list[[x]]
  Idents(seurat_obj) <- "annotation_final"
  df <- FindMarkers(
    seurat_obj,
    ident.1 = comparisons[[x]][["richter"]],
    ident.2 = comparisons[[x]][["cll"]],
    only.pos = FALSE,
    logfc.threshold = 0
  )
  df <- rownames_to_column(df, "gene")
  df
}) 
names(dea) <- names(comparisons)
dea <- purrr::map(names(dea), function(x) {
  df <- dea[[x]]
  df$direction <- case_when(
    df$p_val_adj < alpha & df$avg_log2FC > min_avg_log2FC ~ "up",
    df$p_val_adj < alpha & df$avg_log2FC < 0 & abs(df$avg_log2FC) > min_avg_log2FC ~ "down"
  )
  df$direction[is.na(df$direction)] <- "not sig."
  pct_cells <- rowMeans(seurat_list[[x]][["RNA"]]@counts > 0) * 100
  df$pct_cells_expressing <- pct_cells[df$gene]
  df
})
names(dea) <- names(comparisons)
upregulated_richter <- purrr::map(dea, function(df) df$gene[df$direction == "up"])
downregulated_richter <- purrr::map(dea, function(df) df$gene[df$direction == "down"])
```


# Upset plots

```{r}
upset_upregulated <- upset(fromList(upregulated_richter), order.by = "freq")
upset_downregulated <- upset(fromList(downregulated_richter), order.by = "freq")
upset_upregulated
upset_downregulated
```


# MA plots

TODO: add titles + visualize FC > 1:

```{r fig.wide=TRUE}
ma_plots <- purrr::map(dea, function(df) {
  p <- ma_plot(
    df,
    selected_avg_log2FC = selected_avg_log2FC,
    selected_pct_cells = selected_pct_cells,
    selected_significance_alpha = selected_significance_alpha
  )
  p
})
ma_plots
```

* KLF6: [Assignment of the human B-cell-derived (BCD1) proto-oncogene to 10p14-p15 ](https://www.sciencedirect.com/science/article/abs/pii/S0888754397948242?via%3Dihub)
* [TCL1A and ATM are co-expressed in chronic lymphocytic leukemia cells without deletion of 11q](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3561435/).
* [The regulatory interaction of EVI1 with the TCL1A oncogene impacts cell survival and clinical outcome in CLL](https://www.nature.com/articles/leu2015114)


# Gene ontology enrichment analysis

## EnrichR

### Patient-specific richter GO enrichment

```{r}
# Run enrichR
go_patient_specific <- purrr::map(
  list(upregulated_richter, downregulated_richter),
  function(gene_sets) {
    go_out <- purrr::map(gene_sets, function(x) {
      df <- run_enrichr(
        x,
        max_total_genes = GO_max_total_genes,
        min_enriched_genes = GO_min_enriched_genes,
        p_adj_threshold = GO_p_adj_threshold,
        min_odds_ratio = GO_min_odds_ratio
      )
      df
    })
})


# Visualize upregulated GO terms
names(go_patient_specific) <- c("upregulated", "downregulated")
DT::datatable(go_patient_specific$upregulated$`12`)
DT::datatable(go_patient_specific$upregulated$`19`)
DT::datatable(go_patient_specific$upregulated$`3299`)
DT::datatable(go_patient_specific$upregulated$`63`)


# Visualize downregulated GO terms
DT::datatable(go_patient_specific$downregulated$`12`)
DT::datatable(go_patient_specific$downregulated$`19`)
DT::datatable(go_patient_specific$downregulated$`3299`)
DT::datatable(go_patient_specific$downregulated$`63`)
```


### Common DEG in patients 12 and 63

```{r}
# Common in donors 63 and 12
upregulated_12_63 <- intersect(
  upregulated_richter$`12`,
  upregulated_richter$`63`
)
downregulated_12_63 <- intersect(
  downregulated_richter$`12`,
  downregulated_richter$`63`
)
go_12_63_up <- run_enrichr(
  upregulated_12_63,
  max_total_genes = GO_max_total_genes,
  min_enriched_genes = GO_min_enriched_genes,
  p_adj_threshold = GO_p_adj_threshold,
  min_odds_ratio = GO_min_odds_ratio
)
go_12_63_down <- run_enrichr(
  downregulated_12_63,
  max_total_genes = GO_max_total_genes,
  min_enriched_genes = GO_min_enriched_genes,
  p_adj_threshold = GO_p_adj_threshold,
  min_odds_ratio = GO_min_odds_ratio
)
DT::datatable(go_12_63_up)
DT::datatable(go_12_63_down)
```
[Wnt signalling pathways in chronic lymphocytic leukaemia and B‐cell lymphomas](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5727250/)

```{r}
> DotPlot(seurat_list$`12`, features = "WNT3")
> DotPlot(seurat_list$`19`, features = "WNT3")
> DotPlot(seurat_list$`3299`, features = "WNT3")
> DotPlot(seurat_list$`63`, features = "WNT3")
```


Worth noting, B cell activation is downregulated upon Richter Transformation. This seems counter-intuitive, so we need to check it in more detail.

```{r}
VlnPlot(seurat_list$`63`, c("IGHM", "IGHG1"), group.by = "annotation_final", pt.size = 0.1)
FeaturePlot(seurat_list$`12`, "IGHA1")
```


### Found in at least two sets

```{r}
# Up
all_genes <- Reduce(union, upregulated_richter)
n_sets_all <- map_dbl(all_genes, function(x) {
  n_sets <- sum(
    map_lgl(
      upregulated_richter,
      function(gene_set) x %in% gene_set
    )
  )
  n_sets
})
upregulated_2_or_more <- all_genes[n_sets_all >= 2]
go_2_or_more_up <- run_enrichr(
  upregulated_2_or_more,
  max_total_genes = GO_max_total_genes,
  min_enriched_genes = GO_min_enriched_genes,
  p_adj_threshold = GO_p_adj_threshold,
  min_odds_ratio = GO_min_odds_ratio
)
DT::datatable(go_2_or_more_up)


# Down
n_sets_all_down <- map_dbl(all_genes, function(x) {
  n_sets <- sum(
    map_lgl(
      downregulated_richter,
      function(gene_set) x %in% gene_set
    )
  )
  n_sets
})
downregulated_2_or_more <- all_genes[n_sets_all_down >= 2]
go_2_or_more_down <- run_enrichr(
  downregulated_2_or_more,
  max_total_genes = GO_max_total_genes,
  min_enriched_genes = GO_min_enriched_genes,
  p_adj_threshold = GO_p_adj_threshold,
  min_odds_ratio = GO_min_odds_ratio
)
DT::datatable(go_2_or_more_down)
```


## Gene set enrichment analysis (GSEA)

We know that the results of a GO analysis are sensitive to the tool or statistical method used. Thus, to increase the reliability we will also run a [Gene set enrichment analysis](https://yulab-smu.top/clusterProfiler-book/chapter5.html#go-gene-set-enrichment-analysis) with [clusterProfiler](https://yulab-smu.top/clusterProfiler-book/index.html).


```{r}
set.seed(1234)
gsea_patient_specific <- purrr::map(dea, function(df) {
  df <- arrange(df, desc(avg_log2FC))
  gene_list <- df$avg_log2FC
  names(gene_list) <- df$gene
  gsea_results <- gseGO(
    gene_list,
    ont = "BP",
    OrgDb = org.Hs.eg.db,
    keyType = "SYMBOL",
    minGSSize = min_gs_size,
    maxGSSize = max_gs_size,
    seed = TRUE
  )
  gsea_results <- clusterProfiler::simplify(gsea_results, cutoff = 0.35)
  gsea_results@result <- gsea_results@result %>%
    arrange(desc(NES))
  gsea_results
})
DT::datatable(gsea_patient_specific$`12`@result)
DT::datatable(gsea_patient_specific$`19`@result)
DT::datatable(gsea_patient_specific$`3299`@result)
DT::datatable(gsea_patient_specific$`63`@result)


# Plot
dot_plots_gsea <- purrr::map(gsea_patient_specific, function(obj) {
  p <- clusterProfiler::dotplot(obj, showCategory = 40, color = "p.adjust")
  p +
    theme(axis.text.y = element_text(size = 9))
})
oxphos_gg <- purrr::map(gsea_patient_specific, function(obj) {
  p <- gseaplot(
    obj,
    geneSetID = "GO:0006119",
    by = "runningScore",
    title = "oxidative phosphorylation"
  )
  p
})
mitochondrial_translation_gg <- purrr::map(gsea_patient_specific, function(obj) {
  p <- gseaplot(
    obj,
    geneSetID = "GO:0032543",
    by = "runningScore",
    title = "mitochondrial translation"
  )
  p
})
bcr_gg <- purrr::map(gsea_patient_specific, function(obj) {
  p <- gseaplot(
    obj,
    geneSetID = "GO:0050853",
    by = "runningScore",
    title = "BCR signaling"
  )
  p
})
FeaturePlot(seurat_list$`12`, "WNT3") +
  scale_color_viridis_c(option = "magma")
FeaturePlot(seurat_list$`63`, "WNT3") +
  scale_color_viridis_c(option = "magma")
```


Importantly, we see that some RT have an increased mitochondrial respiration. Of note, several studies link mitochondrial metabolism with CLL and/or DLBCL:

* [Targeting metabolism and survival in chronic lymphocytic leukemia and Richter syndrome cells by a novel NF-κB inhibitor](https://haematologica.org/article/view/8251).
* [Mitochondrial and glycolytic metabolic compartmentalization in diffuse large B-cell lymphoma](https://www.sciencedirect.com/science/article/abs/pii/S0093775417301355?via%3Dihub).
* [Differential contribution of the mitochondrial translation pathway to the survival of diffuse large B-cell lymphoma subsets](https://www.nature.com/articles/cdd2016116).


# Calculate signatures

```{r}
signatures <- list(
  b_cell_signaling = gsea_patient_specific$`12`@geneSets$`GO:0050853`,
  oxphos = gsea_patient_specific$`12`@geneSets$`GO:0006119`,
  mitochondrial_translation = gsea_patient_specific$`12`@geneSets$`GO:0032543`
)
seurat_list <- purrr::map(seurat_list, function(seurat_obj) {
  seurat_obj <- AddModuleScore(
    seurat_obj,
    features = signatures,
    name = names(signatures)
  )
  seurat_obj
})
```

Is the OXPHOS signature of patients 12 and 63 already present at diagnosis, or is it an acquired resistance mechanism against BTK inhibitors?

```{r}
Idents(seurat_list$`12`) <- "annotation_final"
Idents(seurat_list$`63`) <- "annotation_final"
richter_annotations <- c(
  "CCND2hi Richter-like quiescent",
  "CCND2lo Richter-like quiescent",
  "Richter-like proliferative",
  "Richter-like"
)
signatures_vars <- c("b_cell_signaling1", "oxphos2", "mitochondrial_translation3")
signatures_titles <- c(
  "BCR Signaling Score",
  "OXPHOS Score",
  "Mitochondrial Translation Score"
)
color_violin <- c("#dcdddc", "#cd8899")
signatures_violin_p <- purrr::map(c("12", "63"), function(patient) {
  seurat_obj <- seurat_list[[patient]]
  seurat_obj$is_richter_like <- ifelse(
    seurat_obj$annotation_final %in% richter_annotations,
    "Richter-like",
    "CLL-like"
  )
  ps <- purrr::map2(signatures_vars, signatures_titles, function(var, y_lab) {
    p <- seurat_obj@meta.data %>%
      mutate(sample_description2 = str_c(
        time_point,
        sample_description,
        sep = "_"
      ))  %>% 
      ggplot(aes_string(
        "sample_description2",
        var,
        fill = "is_richter_like",
        color = "is_richter_like"
      )) +
        geom_violin(alpha = 0.35) +
        geom_sina(size = 0.5, alpha = 1) +
        scale_color_manual(values = color_violin) +
        scale_fill_manual(values = color_violin) +
        labs(title = x, x = "", y = y_lab, color = "", fill = "") +
        theme_bw() +
        theme(
          axis.text.x = element_text(angle = 45, hjust = 0.95, color = "black"),
          plot.title = element_text(size = 12, hjust = 0.5)
        )
    p
  })
  out <- ggarrange(plotlist = ps, ncol = 3, common.legend = TRUE)
  out
})
seurat_list$`12`$is_richter_like <- ifelse(
  seurat_list$`12`$annotation_final %in% richter_annotations,
  "Richter-like",
  "CLL-like"
)
seurat_list$`12`@meta.data %>%
  mutate(sample_description2 = str_c(
    time_point,
    sample_description_FN,
    sep = "_"
  ))  %>% 
  ggplot(aes(sample_description2, oxphos2, fill = is_richter_like, color = is_richter_like)) +
    geom_violin(alpha = 0.35) +
    geom_sina(size = 0.5, alpha = 1) +
    scale_color_manual(values = c("#dcdddc", "#cd8899")) +
    scale_fill_manual(values = c("#dcdddc", "#cd8899")) +
    labs(x = "", y = "OXPHOS score", color = "", fill = "") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 0.95, color = "black"))

```


# Save

```{r}
saveRDS(upregulated_richter, path_to_save_richter_signature)
saveRDS(downregulated_richter, path_to_save_cll_signature)
```


# Session Information

```{r}
sessionInfo()
```

