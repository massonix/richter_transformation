---
title: 'Analysis patient 365'
author: "Ramon Massoni-Badosa"
date: "2021/04/09"
output: 
  BiocStyle::html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "100%", fig.align='center', 
                      message=FALSE, warning = FALSE)
options(width = 1200)
```


# Introduction

Here, we will analyse the scRNA-seq data from patient with id 365. We left it for the end because both sequential clinical samples (CLL and RT) come from two different anatomical locations (PB and lymph node), hence introducing a large confounding factor.


# Pre-processing

## Load packages

```{r}
library(Seurat)
library(SeuratWrappers)
library(harmony)
library(tidyverse)
```


## Define parameters

```{r}
path_to_obj <- here::here("results/R_objects/4.seurat_leukemic.rds")


# Thresholds
max_pct_mt <- 15


# Source functions
source(here::here("bin/utils.R"))
```


## Load data

```{r}
seurat <- readRDS(path_to_obj)z
seurat <- subset(seurat, subset = donor_id == "365")
table(seurat$time_point, seurat$tissue)
```


# Process Seurat object

```{r}
seurat <- NormalizeData(seurat)
seurat <- process_seurat(seurat, dims = 1:20)
DimPlot(seurat, group.by = "subproject")
DimPlot(seurat, group.by = "tissue")
```

As we can see, there is a large batch effect between subprojects. Thus, we will run [Harmony](https://www.nature.com/articles/s41592-019-0619-0).


# Batch effect correction

```{r}
seurat <- RunHarmony(
  seurat,
  dims = 1:20,
  reduction = "pca",
  group.by.vars = "subproject"
)
seurat <- RunUMAP(seurat, reduction = "harmony", dims = 1:20)
plot_split_umap(seurat, var = "subproject")
plot_split_umap(seurat, var = "tissue")
plot_split_umap(seurat, var = "time_point")
```


# Cluster

```{r}
seurat <- FindNeighbors(
  seurat,
  reduction = "harmony",
  dims = 1:20
)
seurat <- FindClusters(seurat, resolution = 0.5)
FeaturePlot(seurat, "pct_mt") +
  scale_color_viridis_c(option = "magma")
DimPlot(seurat)
VlnPlot(seurat, features = "pct_mt", pt.size = 0)
```

We observe that some clusters are composed of poor-quality cells (high mitochondrial expression). Thus, let us be more stringent with the threshold:

```{r}
seurat@meta.data %>%
  ggplot(aes(pct_mt)) +
    geom_histogram() +
    theme_bw()
seurat <- subset(seurat, pct_mt < max_pct_mt)
```


Reprocess:

```{r}
seurat <- process_seurat(seurat, dims = 1:20)
seurat <- RunHarmony(
  seurat,
  dims = 1:20,
  reduction = "pca",
  group.by.vars = "subproject"
)
seurat <- RunUMAP(seurat, reduction = "harmony", dims = 1:20)
seurat <- FindNeighbors(seurat, reduction = "harmony", dims = 1:20)
seurat <- FindClusters(seurat, resolution = 0.6)
DimPlot(seurat)
```


# Markers

```{r}
markers_df <- FindAllMarkers(
  seurat,
  logfc.threshold = 0.65,
  only.pos = TRUE
)
markers_df <- markers_df %>%
  group_by(cluster) %>%
  arrange(desc(avg_log2FC), .by_group = TRUE)
markers_df <- markers_df[, c(7, 6, 2, 5, 3, 4)]
DT::datatable(markers_df)
```

